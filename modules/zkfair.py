import asyncio

from modules.utils import logger
from modules.wallet import Wallet
import settings


class ZkFair(Wallet):
    def __init__(self, wallet: Wallet):
        super().__init__(privatekey=wallet.privatekey, recipient=wallet.recipient, tg_report=wallet.tg_report, browser=wallet.browser, proxy=wallet.proxy)

        self.chain = 'zkfair'
        self.web3 = self.get_web3(self.chain)


    async def get_refund(self, contract_address: str, refund_value: int, refund_index: int, refund_merkle: list, retry=0):
        try:
            amount_to_refund = round(refund_value / 1e18, 2)
            module_str = f'get refund {amount_to_refund} USDC'

            await self.wait_for_gwei()

            refund_contract = self.web3.eth.contract(address=self.web3.to_checksum_address(contract_address),
                                                        abi='[{"type":"function","name":"claim","constant":false,"inputs":[{"name":"index","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true},{"name":"amount","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true},{"name":"merkleProof","type":"bytes32[]","indexed":null,"components":null,"arrayLength":-1,"arrayChildren":{"name":null,"type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true},"baseType":"array","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"initialize","constant":false,"inputs":[{"name":"_initialOwner","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_zkfTokenAddress","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_proposalAuthority","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_reviewAuthority","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_totalOutput","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"error","name":"InvalidInitialization","inputs":[],"_isFragment":true},{"type":"error","name":"NotInitializing","inputs":[],"_isFragment":true},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"_isFragment":true},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"_isFragment":true},{"name":"Claimed","anonymous":false,"inputs":[{"name":"index","type":"uint256","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true},{"name":"account","type":"address","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"amount","type":"uint256","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"type":"event","_isFragment":true},{"name":"Initialized","anonymous":false,"inputs":[{"name":"version","type":"uint64","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint64","_isParamType":true}],"type":"event","_isFragment":true},{"name":"NewAddFeeRecordEvent","anonymous":false,"inputs":[{"name":"receiveAddress","type":"address","indexed":true,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"type":"event","_isFragment":true},{"name":"OwnershipTransferred","anonymous":false,"inputs":[{"name":"previousOwner","type":"address","indexed":true,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"newOwner","type":"address","indexed":true,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"type":"event","_isFragment":true},{"type":"function","name":"proposewMerkleRoot","constant":false,"inputs":[{"name":"_merkleRoot","type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"renounceOwnership","constant":false,"inputs":[],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"reviewPendingMerkleRoot","constant":false,"inputs":[{"name":"_approved","type":"bool","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bool","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"setProposalAuthority","constant":false,"inputs":[{"name":"_account","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"setReviewAuthority","constant":false,"inputs":[{"name":"_account","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"transferOwnership","constant":false,"inputs":[{"name":"newOwner","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"allRewardsAddress","constant":true,"inputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"allRewardsAddressLength","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"firstStartTime","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"isClaimed","constant":true,"inputs":[{"name":"index","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"outputs":[{"name":null,"type":"bool","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bool","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"merkleRoot","constant":true,"inputs":[],"outputs":[{"name":null,"type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"owner","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"pendingMerkleRoot","constant":true,"inputs":[],"outputs":[{"name":null,"type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"proposalAuthority","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"reviewAuthority","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"rewardHistory","constant":true,"inputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"totalDistributedReward","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"totalOutput","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"zkfTokenAddress","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true}]')

            contract_txn = refund_contract.functions.claim(refund_index, refund_value, refund_merkle)
            tx_hash = await self.sent_tx(chain_name=self.chain, tx=contract_txn, tx_label=module_str)
            if tx_hash == 'claimed':
                logger.success(f'{self.address} | Refund already claimed')
                self.tg_report.update_logs(f'✅ refund already claimed')
                return 'claimed'

            return tx_hash

        except Exception as error:
            if retry < settings.RETRY:
                logger.error(f'{module_str} | {error}')
                await asyncio.sleep(10)
                return await self.get_refund(contract_address=contract_address, refund_value=refund_value, refund_index=refund_index, refund_merkle=refund_merkle, retry=retry+1)

            else:
                self.tg_report.update_logs(f'❌ {module_str}: {error}')
                raise ValueError(f'{module_str}: {error}')


    async def get_airdrop(self, contract_address: str, claim_value: int, claim_index: int, airdrop_merkle: list, retry=0):
        try:
            amount_to_claim = round(claim_value / 1e18, 2)
            module_str = f'claim {amount_to_claim} ZKF'

            await self.wait_for_gwei()

            refund_contract = self.web3.eth.contract(address=self.web3.to_checksum_address(contract_address),
                                                        abi='[{"type":"function","name":"claim","constant":false,"inputs":[{"name":"index","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true},{"name":"amount","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true},{"name":"merkleProof","type":"bytes32[]","indexed":null,"components":null,"arrayLength":-1,"arrayChildren":{"name":null,"type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true},"baseType":"array","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"initialize","constant":false,"inputs":[{"name":"_initialOwner","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_zkfTokenAddress","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_proposalAuthority","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_reviewAuthority","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"_totalOutput","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"error","name":"InvalidInitialization","inputs":[],"_isFragment":true},{"type":"error","name":"NotInitializing","inputs":[],"_isFragment":true},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"_isFragment":true},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"_isFragment":true},{"name":"Claimed","anonymous":false,"inputs":[{"name":"index","type":"uint256","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true},{"name":"account","type":"address","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"amount","type":"uint256","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"type":"event","_isFragment":true},{"name":"Initialized","anonymous":false,"inputs":[{"name":"version","type":"uint64","indexed":false,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint64","_isParamType":true}],"type":"event","_isFragment":true},{"name":"NewAddFeeRecordEvent","anonymous":false,"inputs":[{"name":"receiveAddress","type":"address","indexed":true,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"type":"event","_isFragment":true},{"name":"OwnershipTransferred","anonymous":false,"inputs":[{"name":"previousOwner","type":"address","indexed":true,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true},{"name":"newOwner","type":"address","indexed":true,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"type":"event","_isFragment":true},{"type":"function","name":"proposewMerkleRoot","constant":false,"inputs":[{"name":"_merkleRoot","type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"renounceOwnership","constant":false,"inputs":[],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"reviewPendingMerkleRoot","constant":false,"inputs":[{"name":"_approved","type":"bool","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bool","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"setProposalAuthority","constant":false,"inputs":[{"name":"_account","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"setReviewAuthority","constant":false,"inputs":[{"name":"_account","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"transferOwnership","constant":false,"inputs":[{"name":"newOwner","type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[],"payable":false,"stateMutability":"nonpayable","gas":null,"_isFragment":true},{"type":"function","name":"allRewardsAddress","constant":true,"inputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"allRewardsAddressLength","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"firstStartTime","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"isClaimed","constant":true,"inputs":[{"name":"index","type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"outputs":[{"name":null,"type":"bool","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bool","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"merkleRoot","constant":true,"inputs":[],"outputs":[{"name":null,"type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"owner","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"pendingMerkleRoot","constant":true,"inputs":[],"outputs":[{"name":null,"type":"bytes32","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"bytes32","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"proposalAuthority","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"reviewAuthority","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"rewardHistory","constant":true,"inputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"totalDistributedReward","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"totalOutput","constant":true,"inputs":[],"outputs":[{"name":null,"type":"uint256","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"uint256","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true},{"type":"function","name":"zkfTokenAddress","constant":true,"inputs":[],"outputs":[{"name":null,"type":"address","indexed":null,"components":null,"arrayLength":null,"arrayChildren":null,"baseType":"address","_isParamType":true}],"payable":false,"stateMutability":"view","gas":null,"_isFragment":true}]')

            contract_txn = refund_contract.functions.claim(claim_index, claim_value, airdrop_merkle)
            tx_hash = await self.sent_tx(chain_name=self.chain, tx=contract_txn, tx_label=module_str)
            if tx_hash == 'claimed':
                logger.success(f'{self.address} | Airdrop already claimed')
                self.tg_report.update_logs(f'✅ airdrop already claimed')
            return tx_hash

        except Exception as error:
            if retry < settings.RETRY:
                logger.error(f'{module_str} | {error}')
                await asyncio.sleep(10)
                return await self.get_airdrop(contract_address=contract_address, claim_value=claim_value, claim_index=claim_index, airdrop_merkle=airdrop_merkle, retry=retry+1)

            else:
                self.tg_report.update_logs(f'❌ {module_str}: {error}')
                raise ValueError(f'{module_str}: {error}')
